<!DOCTYPE html>
<html>
<head>
  <title>Bootstrap模态框中的表格示例</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="FI003_TableRowFactory.js"></script>
  <script src="common.js"></script>
</head>



<body>
  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
    打开模态框
  </button>

  <!-- 模态框 -->
  <div class="modal" id="myModal">
    <div class="modal-dialog">
      <div class="modal-content">

        <!-- 模态框头部 -->
        <div class="modal-header">
          <h4 class="modal-title">表格示例</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <!-- 模态框主体 -->
        <div class="modal-body">
            <table class="table" id="currtable">
                <thead>
                  <tr>
                    <th>Currency</th>
                    <th>MRate</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><select class="currency">
                      <option value=0 selected>USD</option>
                      <option value=1>TWD</option>
                    </select></td>
                    <td><input type="number" value="1"></td>
                  </tr>
                  <tr>
                    <td><select class="currency">
                      <option value=0>USD</option>
                      <option value=1 selected>TWD</option>
                    </select></td>
                    <td><input type="number" value="30"></td>
                  </tr>
                </tbody>
              </table>
          <button type="button" class="btn btn-success" id="curraddRow">新增行</button>
        </div>

        <!-- 模态框底部 -->
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="confirmChanges">确认</button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">关闭</button>
        </div>

      </div>
    </div>
  </div>

  <table class="table" id="Paymentdetail">
    <div><button type="button" class="btn btn-success" id="addPaymentdetailRow">添加行</button>
    <button type="button" class="btn btn-danger" id="DeletePaymentdetailRow" disabled >刪除行</button>
    </div>
      <thead>
      <tr>
        <th><input type="checkbox"  id="checkallPaymentdetail"></th>
        <th>No.</th>
        <th>費用項目</th>
        <th>起日</th>
        <th>迄日</th>
        <th>幣别</th>
        <th>金額</th>
        <th>匯率</th>
        <th>付款金額</th>
        <th>區域</th>
     
      </tr>
    </thead>
    <tbody>
     
    </tbody>
  </table>

<hr>
<div>

  <table class="table" id="Mealdetail">
    <div><button type="button" class="btn btn-success" id="addMealdetailRow">添加行</button>
      <button type="button" class="btn btn-danger" id="DeleteMealdetailRow" disabled >刪除行</button>
      </div>
    <thead>
      <tr>
        <th style="width:100px;"><input type="checkbox"  id="checkallMealdetail"></th>
        <th>No.</th>
        <th>日期</th>
        <th>地區</th>
        <th>幣別</th>
        <th>早餐</th>
        <th>金額</th>
        <th>午餐</th>
        <th>金額</th>
        <th>晚餐</th>
        <th>金額</th>
        <th>說明</th>
    
      </tr>
    </thead>
    <tbody>
    </tbody>
  <!-- <tr > -->

    <!-- <td><input type="text"  value="2023/9/1"></td>
    <td>
       <select class="region">
      <option value=0>CHINA</option>
      <option value=1>US</option>
    </select>
    
    </td>
    <td> <select class="currency-select">
      <option value=0>USD</option>
      <option value=1>TWD</option>
    </select>
  </td>
    <td><input type="checkbox" name="morning" checked></td>
    <td><input type="number" name="morningAmount" value="10"></td>
    <td><input type="checkbox" name="noon" checked></td>
    <td><input type="number" name="noonAmount" value="10"></td>
    <td><input type="checkbox" name="afternoon" checked></td>
    <td><input type="number" name="afternoonAmount" value="15"></td>
    <td><textarea name="description"></textarea></td> -->

  <!-- </tr> -->


   </table>
   <div>
   
    <button type="button" class="btn btn-primary" id="checkAll">Check All</button>
    <button type="button"  class="btn btn-primary"  id="uncheckAll">Uncheck All</button>
 
    <!-- <td align="center" colspan="7" >列数要根据你的表格列数来设置 -->
    <button type="button" class="btn btn-primary" id="addMealDeailToPayment">OK</button>
    <button type="button" class="btn btn-primary" id="submitData">submitData</button>
    </div>

  </div>

<!-- 提交按钮 -->
<!-- <button type="button" class="btn btn-primary" id="submitData">submit</button> -->











  <script>



 //detailtable addrow and delete row event
 TableSchemaHandling("Paymentdetail","PaymentDetailRow");
 TableActionHandling("Paymentdetail");


 TableSchemaHandling("Mealdetail","MealDetailRow");
 TableActionHandling("Mealdetail");



$("#addMealDeailToPayment").on("click", () => {
  const mealRows = $("#Mealdetail tbody tr");
  const selectedDates = [];
 // const NewRowList = [];
 // 用对象来分组，以地区和幣別为键
 const groupedData = {};
 let hasDuplicateDate = false; // 用于跟踪是否有重复日期
// 时删除PaymentDetail中的特定費用項目膳食費的数据
  $("#Paymentdetail tbody tr").each((index, row) => {
    const $row = $(row);
    const category = $row.find("select.Category option:selected").text();
    if (category === "膳食費") {
      $row.remove();
    }
  });

  let uniqueIndex = 1;
  mealRows.each((index, row) => {
    const $row = $(row);
    const selectedRegion = $row.find("select.MealRegion option:selected").val();
    const selectedCurrency = $row.find("select.MealCurrency option:selected").val();
    const startDate = new Date($row.find("input[type=date]").val());
    if (selectedDates.includes(startDate.toLocaleDateString())) {
      alert("日期重複！");
      hasDuplicateDate = true;
      return false;
    }
   
    const key = selectedRegion + "_" + selectedCurrency;
    
    if (!groupedData[key]) {
      groupedData[key] = {
        index:uniqueIndex++,
        category: "1",
        startDate: startDate,
        endDate: startDate,
        currency: selectedCurrency,
        AmountWithoutTax: 0,
        ExchangeRate: 1,
        TotalAmount: 0,
        Region: selectedRegion,
      };

    } else {
      // 更新日期範圍
      if (startDate < groupedData[key].startDate) {
        groupedData[key].startDate = startDate;
      }
      if (startDate > groupedData[key].endDate) {
        groupedData[key].endDate = startDate;
      }
    }
   // 获取morning checkbox的状态
    const isMorningChecked = $row.find("input[name=breakfast]").is(":checked");
    const isNoonChecked = $row.find("input[name=Lunch]").is(":checked");
    const isAfternoonChecked = $row.find("input[name=Dinner]").is(":checked");

    // 更新金額
    const morningAmount = isMorningChecked? parseFloat($row.find("input[name=breakfastAmt]").val()) || 0 :0;
    const noonAmount = isNoonChecked? parseFloat($row.find("input[name=LunchAmt]").val()) || 0:0;
    const afternoonAmount = isAfternoonChecked?parseFloat($row.find("input[name=DinnerAmt]").val()) || 0:0;
   // 遍历currtable查找对应的MRate
    groupedData[key].ExchangeRate=findExchangeRate(selectedCurrency);
    groupedData[key].AmountWithoutTax += (morningAmount + noonAmount + afternoonAmount);
    groupedData[key].TotalAmount += (morningAmount + noonAmount + afternoonAmount)*groupedData[key].ExchangeRate;


    selectedDates.push(startDate.toLocaleDateString());
   
  });
  
  if (hasDuplicateDate) {
    return; // 如果有重复日期，停止执行后续代码
  }


    LoadDatatoTable("Paymentdetail","PaymentDetailRow",groupedData);


});


function findExchangeRate(selectedCurrency) {
  const currRows = $("#currtable tbody tr");
  let exchangeRate = 1; // 默认值

  currRows.each((index, row) => {
    const $row = $(row);
    const currency = $row.find("select.currency").eq(0).val(); // 获取第一个select元素的值
    const MRate = parseFloat($row.find("input[type=number]").val());

    if (currency === selectedCurrency) {
      exchangeRate = MRate; // 找到匹配的currency，更新exchangeRate
      return false; // 停止遍历
    }
  });

  return exchangeRate;
}




// 检查Meal Detail表格中的所有复选框
$("#checkAll").on("click", function () {
  $("#Mealdetail tbody tr td:not(:first-child) input[type=checkbox]").prop("checked", true);
});

// 取消检查Meal Detail表格中的所有复选框
$("#uncheckAll").on("click", function () {
  $("#Mealdetail tbody tr td:not(:first-child) input[type=checkbox]").prop("checked", false);
});






    // 新增行按钮点击事件
    $("#curraddRow").click(function() {
      // 创建新行
      var newRow = $("<tr>");
      newRow.append('<td><input type="text" class="form-control"></td>');
      newRow.append('<td><input type="text" class="form-control"></td>');
      newRow.append('<td><button type="button" class="btn btn-danger deleteRow">删除</button></td>');

      // 将新行添加到表格中
      $("#currtable tbody").append(newRow);
    });

    // 删除行按钮点击事件
    $("#currtable").on("click", ".deleteRow", function() {
      $(this).closest("tr").remove();
    });

    var originalRates = {}; // 用于存储模态框内表格的原始汇率数值
var modified = false; // 标记是否有输入或选择元素的值发生变化

// 监听模态框内输入和选择元素的变化
$("#currtable").on("input change", "input[type='number']", function () {
  var currency = $(this).closest("tr").find("td:eq(0)").text();
  originalRates[currency] = parseFloat($(this).data("original-rate"));
  modified = true; // 标记值发生变化
});

// 监听模态框关闭前的事件
$("#myModal").on("hide.bs.modal", function (e) {
  // 如果值发生变化，弹出确认对话框
  if (modified) {
    var confirmed = confirm("您尚未儲存，確定要離開吗？");

    if (confirmed) {
        modified = false; // 用户确认离开，重置标记
      // 还原更改的汇率数值
      restoreExchangeRate();
    } else {
      e.preventDefault(); // 阻止模态框关闭
   //   modified = false; // 用户确认离开，重置标记
    }
  }
});




    // 监听确认按钮点击事件
$("#confirmChanges").click(function () {
  var modified = false; // 标记是否有输入或选择元素的值发生变化

  // 检查模态框内输入和选择元素的值是否发生变化
  $("#currtable tbody tr").each(function () {
    var currency = $(this).find("td:eq(0)").text();
    var input = $(this).find("input[type='number']");
    var currentValue = parseFloat(input.val());

    if (originalRates[currency] !== currentValue) {
      modified = true; // 至少有一个元素的值发生了变化
      originalRates[currency] = currentValue; // 更新原始值
    }
  });

  // 如果有元素的值发生变化，弹出确认对话框
  if (modified) {
    var confirmed = confirm("更改匯率表後，現有費用資料將刪除，確認執行?");

    if (confirmed) {
      // 用户点击确认，执行更新操作，可以在这里执行更新模态框内表格的操作
      // 更新完成后关闭模态框
      $("#myModal").modal('hide');

      // 弹出确认信息
      alert("更新已确认，模态框已关闭");
    } else {
      // 用户点击取消，还原模态框内表格的数值
      restoreExchangeRate();
    }
  }
});


// 还原更改的汇率数值
function restoreExchangeRate() {
  // 获取模态框内表格的原始汇率数值
  var originalRates = {};
  $("#currtable tbody tr").each(function () {
    var currency = $(this).find("td:eq(0)").text();
    var originalRate = parseFloat($(this).find("td:eq(1) input").data("original-rate"));
    originalRates[currency] = originalRate;
  });

  // 更新模态框内表格的数值
  $("#currtable tbody tr").each(function () {
    var currency = $(this).find("td:eq(0)").text();
    var input = $(this).find("td:eq(1) input");
    input.val(originalRates[currency]);
  });
}






    // 提交按钮点击事件
    $("#submitData").click(function() {
      // 创建一个空的JSON数组来存储表格数据
   
   
      const mealDetailConfig = {
    id: { selector: 'input.SerialNo', transform: parseInt },
    date: { selector: 'input.MealDate' },
    region: { selector: 'select.MealRegion' },
    currency: { selector: 'select.MealCurrency' },
    breakfastF: { selector: 'input.breakfast', transform: Boolean },
    breakfastA: { selector: 'input.BreakfastAmt', transform: parseFloat },
    LunchF: { selector: 'input.Lunch', transform: Boolean },
    LunchA: { selector: 'input.LunchAmt', transform: parseFloat },
    DinneF: { selector: 'input.Dinner', transform: Boolean },
    aftDinnerA: { selector: 'input.DinnerAmt', transform: parseFloat },
    desc: { selector: 'textarea.Description' },
  };
  
  const mealDetailJSON = convertTableToJSON('#Mealdetail', mealDetailConfig);
  console.log(mealDetailJSON);



    });






    //通用建立Table資料結構及action 
function TableSchemaHandling(TableID,className)
{
    //add row handling
    $("#add"+TableID+"Row").click(function() {

      console.log(TableID+','+className);
    let maxIndex = 0;
    $("#"+TableID+" tbody tr").each(function () {
      const currentIndex = parseInt($(this).find("td:eq(1) input").val(), 10);
      if (!isNaN(currentIndex) && currentIndex > maxIndex) {
        maxIndex = currentIndex;
      }
    });
    // 在页面加载时创建一些初始的<tr>元素，并将它们添加到tableRows数组中
    const tableBody = $("#"+TableID+" tbody");
    //console.log(maxIndex);
      // Dynamically create an instance of the specified class
      const tableRow = new TableRowFactory.createTableRow(maxIndex + 1,className);
     // tableRows.push(tableRow);
      tableBody.append(tableRow.tr); 
      $("#checkall"+TableID).prop("checked",false);
    });
}

   //通用資料操作
  function TableActionHandling(TableID)
  
  {
    // 删除行按鈕事件部分
    $("#"+TableID).on("change", "input[type='checkbox']", function () {
      const anyChecked = $("#"+TableID+" tbody input[type='checkbox']:checked").length > 0;
      $("#Delete"+TableID+"Row").prop("disabled", !anyChecked);
    });
    //DeletePaymentdetailRow
    $("#Delete"+TableID+"Row").click(function() {
      $("#"+TableID +" tbody tr").each((index, row) => {
      const $row = $(row);
      // Check if the checkbox is checked
      const isChecked =$row .find("input[type='checkbox']").prop("checked");
      if (isChecked)
      {$row.remove();
       $("#checkall"+TableID).prop("checked",false);
       $("#Delete"+TableID+"Row").prop('disabled', true);
      } 
    });
  });
  
    // 整批點選
  
    $("#checkall"+TableID).on("click", function () {
      $(this).is(":checked")?
      $("#"+TableID +" tbody td:first-child input[type=checkbox]").prop("checked", true)
      :
      $("#"+TableID +" tbody td:first-child input[type=checkbox]").prop("checked", false);
    });

  }

  
//load json to create data

function LoadDatatoTable(TableID,ClassName,data)
{
  const tableBody = document.getElementById(TableID).querySelector('tbody'); 
for (const key in data) {
  if (Object.hasOwnProperty.call(data, key)) {
    const rowData = data[key];
    const index = rowData.index; ; // Extract the index from the key
    const row = TableRowFactory.createTableRow(index, ClassName, rowData);
    tableBody.appendChild(row.tr);
  }
}

}




  </script>
</body>
</html>
