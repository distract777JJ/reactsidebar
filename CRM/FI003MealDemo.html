<!DOCTYPE html>
<html>
<head>
  <title>Bootstrap模态框中的表格示例</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>



<body>
  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
    打开模态框
  </button>

  <!-- 模态框 -->
  <div class="modal" id="myModal">
    <div class="modal-dialog">
      <div class="modal-content">

        <!-- 模态框头部 -->
        <div class="modal-header">
          <h4 class="modal-title">表格示例</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <!-- 模态框主体 -->
        <div class="modal-body">
            <table class="table" id="currtable">
                <thead>
                  <tr>
                    <th>Currency</th>
                    <th>MRate</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><select class="currency">
                      <option value=0 selected>USD</option>
                      <option value=1>TWD</option>
                    </select></td>
                    <td><input type="number" value="1"></td>
                  </tr>
                  <tr>
                    <td><select class="currency">
                      <option value=0>USD</option>
                      <option value=1 selected>TWD</option>
                    </select></td>
                    <td><input type="number" value="30"></td>
                  </tr>
                </tbody>
              </table>
          <button type="button" class="btn btn-success" id="curraddRow">新增行</button>
        </div>

        <!-- 模态框底部 -->
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="confirmChanges">确认</button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">关闭</button>
        </div>

      </div>
    </div>
  </div>

  <table class="table" id="paymentdetail">
    <thead>
      <tr>
        <th>费用项目</th>
        <th>起日</th>
        <th>迄日</th>
        <th>币别</th>
        <th>金额</th>
        <th>汇率</th>
        <th>付款金额</th>
        <th>區域</th>
        <th>  <button type="button" class="btn btn-success" id="addRow">添加行</button></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <select class="category">
            <option value=0>旅費</option>
            <option value=1>膳食費</option>
          </select>
        </td>
        <td ><input type="text" class="Sdate" ></td></td>
        <td ><input type="text" class="Edate" ></td></td>
        <td>
          <select class="currency-select">
            <option value=0>USD</option>
            <option value=1>TWD</option>
          </select>
        </td>
        <td><input type="number" class="amount" value="100"></td>
        <td><input type="number" class="exchange-rate" readonly></td>
        <td><input type="number" class="payment-amount" readonly></td>
        <td> <select class="region">
          <option value=0>CHINA</option>
          <option value=1>US</option>
        </select></td>
        <td><button type="button" class="btn btn-danger delete-row">删除</button></td>
      </tr>
      <!-- 可以添加更多行 -->
    </tbody>
  </table>

<hr>
<div>

  <table class="table" id="MealDetail">
    <thead>
      <tr>
        <th>日期</th>
        <th>地區</th>
        <th>幣別</th>
        <th>早餐</th>
        <th>金额</th>
        <th>午餐</th>
        <th>金额</th>
        <th>晚餐</th>
        <th>金额</th>
        <th>說明</th>
        <th>  <button type="button" class="btn btn-success" id="addmealRow">添加行</button></th>
      </tr>
    </thead>


  <tr >

    <td><input type="text"  value="2023/9/1"></td>
    <td>
       <select class="region">
      <option value=0>CHINA</option>
      <option value=1>US</option>
    </select>
    
    </td>
    <td> <select class="currency-select">
      <option value=0>USD</option>
      <option value=1>TWD</option>
    </select>
  </td>
    <td><input type="checkbox" name="morning" checked></td>
    <td><input type="number" name="morningAmount" value="10"></td>
    <td><input type="checkbox" name="noon" checked></td>
    <td><input type="number" name="noonAmount" value="10"></td>
    <td><input type="checkbox" name="afternoon" checked></td>
    <td><input type="number" name="afternoonAmount" value="15"></td>
    <td><textarea name="description"></textarea></td>
    <td><button type="button" class="btn btn-danger delete-row">删除</button></td>
  </tr>
    <tfoot>
      <tr> <td colspan="1"> <!-- 列数要根据你的表格列数来设置 -->
        <button type="button" class="btn btn-primary" id="checkAll">Check All</button>
        <button type="button"  class="btn btn-primary"  id="uncheckAll">Uncheck All</button>
        <td>
          <td align="center" colspan="7" ><!-- 列数要根据你的表格列数来设置 -->
          <button type="button" class="btn btn-primary" id="addMealToPayment">OK</button>
         
        </td>
      </tr>
    </tfoot>

 


  </div>

<!-- 提交按钮 -->
<button type="button" class="btn btn-primary" id="submitData">submit</button>











  <script>


$("#addMealToPayment").on("click", () => {
  const mealRows = $("#MealDetail tbody tr");
  const selectedDates = [];
 // 用对象来分组，以地区和幣別为键
 const groupedData = {};
 let hasDuplicateDate = false; // 用于跟踪是否有重复日期
// 时删除PaymentDetail中的特定費用項目膳食費的数据
  $("#paymentdetail tbody tr").each((index, row) => {
    const $row = $(row);
    const category = $row.find("select.category option:selected").text();
    if (category === "膳食費") {
      $row.remove();
    }
  });


  mealRows.each((index, row) => {
    const $row = $(row);
    const selectedRegion = $row.find("select.region option:selected").val();
    const selectedCurrency = $row.find("select.currency-select option:selected").val();
    const startDate = new Date($row.find("input[type=text]").eq(0).val());
    if (selectedDates.includes(startDate.toLocaleDateString())) {
      alert("日期重複！");
      hasDuplicateDate = true;
      return false;
    }
    const key = selectedRegion + "_" + selectedCurrency;
    
    if (!groupedData[key]) {
      groupedData[key] = {
        category: "1",
        startDate: startDate,
        endDate: startDate,
        currency: selectedCurrency,
        amount: 0,
        exchangeRate: 1,
        paymentAmount: 0,
        region: selectedRegion,
      };
    } else {
      // 更新日期範圍
      if (startDate < groupedData[key].startDate) {
        groupedData[key].startDate = startDate;
      }
      if (startDate > groupedData[key].endDate) {
        groupedData[key].endDate = startDate;
      }
    }
   // 获取morning checkbox的状态
    const isMorningChecked = $row.find("input[name=morning]").is(":checked");
    const isNoonChecked = $row.find("input[name=noon]").is(":checked");
    const isAfternoonChecked = $row.find("input[name=afternoon]").is(":checked");

    // 更新金額
    const morningAmount = isMorningChecked? parseFloat($row.find("input[name=morningAmount]").val()) || 0 :0;
    const noonAmount = isNoonChecked? parseFloat($row.find("input[name=noonAmount]").val()) || 0:0;
    const afternoonAmount = isAfternoonChecked?parseFloat($row.find("input[name=afternoonAmount]").val()) || 0:0;
   // 遍历currtable查找对应的MRate
    groupedData[key].exchangeRate=findExchangeRate(selectedCurrency);
    groupedData[key].amount += (morningAmount + noonAmount + afternoonAmount);
    groupedData[key].paymentAmount += (morningAmount + noonAmount + afternoonAmount)*groupedData[key].exchangeRate;





    selectedDates.push(startDate.toLocaleDateString());
  });
  
  if (hasDuplicateDate) {
    return; // 如果有重复日期，停止执行后续代码
  }


  // 將分組的數據添加到paymentdetail中
  for (const key in groupedData) {
    const newRow = $("<tr>");
    newRow.append($("#paymentdetail tbody tr:first td").clone());

    newRow.find("td:eq(0)").find("select").val(groupedData[key].category);
    newRow.find("td:eq(1)").find("input").val(groupedData[key].startDate.toLocaleDateString());
    newRow.find("td:eq(2)").find("input").val(groupedData[key].endDate.toLocaleDateString());
    newRow.find("td:eq(3)").find("select").val(groupedData[key].currency);
    newRow.find("td:eq(4)").find("input").val(groupedData[key].amount);
    newRow.find("td:eq(5)").find("input").val(groupedData[key].exchangeRate);
    newRow.find("td:eq(6)").find("input").val(groupedData[key].paymentAmount);
    newRow.find("td:eq(7)").find("select").val(groupedData[key].region);

    // const deleteButton = $("<button>").attr("type", "button").addClass("btn btn-danger delete-row").text("删除");
    // newRow.append($("<td>").append(deleteButton));

    $("#paymentdetail tbody").append(newRow);
  }


});


function findExchangeRate(selectedCurrency) {
  const currRows = $("#currtable tbody tr");
  let exchangeRate = 1; // 默认值

  currRows.each((index, row) => {
    const $row = $(row);
    const currency = $row.find("select.currency").eq(0).val(); // 获取第一个select元素的值
    const MRate = parseFloat($row.find("input[type=number]").val());

    if (currency === selectedCurrency) {
      exchangeRate = MRate; // 找到匹配的currency，更新exchangeRate
      return false; // 停止遍历
    }
  });

  return exchangeRate;
}


// 检查Meal Detail表格中的所有复选框
$("#checkAll").on("click", function () {
  $("#MealDetail tbody input[type=checkbox]").prop("checked", true);
});

// 取消检查Meal Detail表格中的所有复选框
$("#uncheckAll").on("click", function () {
  $("#MealDetail tbody input[type=checkbox]").prop("checked", false);
});
















    // 当币别选择框的值发生变化或金额字段的值发生变化时，重新计算付款金额
    $("#paymentdetail").on("input change", ".currency-select, .amount", function() {
      calculatePaymentAmount($(this).closest("tr"));
    });



    $("#addRow").click(function() {
      // 复制第一行并添加到表格
      var newRow = $("#paymentdetail tbody tr:first").clone();
      $("#paymentdetail tbody").append(newRow);
      // 清空新增行的输入值
      newRow.find("input").val("");
      newRow.find(".exchange-rate").val("");
      newRow.find(".payment-amount").val("");
      newRow.find(".delete-row").click(function() {
        $(this).closest("tr").remove();
      });
    });

    // 删除行按钮点击事件
    $("#paymentdetail").on("click", ".delete-row", function() {
      $(this).closest("tr").remove();
    });


    $("#addmealRow").click(function() {
      // 复制第一行并添加到表格
      var newRow = $("#MealDetail tbody tr:first").clone();
      $("#MealDetail tbody").append(newRow);
      // 清空新增行的输入值
     
     
      newRow.find(".delete-row").click(function() {
        $(this).closest("tr").remove();
      });
    });

    // 删除行按钮点击事件
    $("#MealDetail").on("click", ".delete-row", function() {
      $(this).closest("tr").remove();
    });







    // 新增行按钮点击事件
    $("#curraddRow").click(function() {
      // 创建新行
      var newRow = $("<tr>");
      newRow.append('<td><input type="text" class="form-control"></td>');
      newRow.append('<td><input type="text" class="form-control"></td>');
      newRow.append('<td><button type="button" class="btn btn-danger deleteRow">删除</button></td>');

      // 将新行添加到表格中
      $("#currtable tbody").append(newRow);
    });

    // 删除行按钮点击事件
    $("#currtable").on("click", ".deleteRow", function() {
      $(this).closest("tr").remove();
    });

    var originalRates = {}; // 用于存储模态框内表格的原始汇率数值
var modified = false; // 标记是否有输入或选择元素的值发生变化

// 监听模态框内输入和选择元素的变化
$("#currtable").on("input change", "input[type='number']", function () {
  var currency = $(this).closest("tr").find("td:eq(0)").text();
  originalRates[currency] = parseFloat($(this).data("original-rate"));
  modified = true; // 标记值发生变化
});

// 监听模态框关闭前的事件
$("#myModal").on("hide.bs.modal", function (e) {
  // 如果值发生变化，弹出确认对话框
  if (modified) {
    var confirmed = confirm("您尚未儲存，確定要離開吗？");

    if (confirmed) {
        modified = false; // 用户确认离开，重置标记
      // 还原更改的汇率数值
      restoreExchangeRate();
    } else {
      e.preventDefault(); // 阻止模态框关闭
   //   modified = false; // 用户确认离开，重置标记
    }
  }
});




    // 监听确认按钮点击事件
$("#confirmChanges").click(function () {
  var modified = false; // 标记是否有输入或选择元素的值发生变化

  // 检查模态框内输入和选择元素的值是否发生变化
  $("#currtable tbody tr").each(function () {
    var currency = $(this).find("td:eq(0)").text();
    var input = $(this).find("input[type='number']");
    var currentValue = parseFloat(input.val());

    if (originalRates[currency] !== currentValue) {
      modified = true; // 至少有一个元素的值发生了变化
      originalRates[currency] = currentValue; // 更新原始值
    }
  });

  // 如果有元素的值发生变化，弹出确认对话框
  if (modified) {
    var confirmed = confirm("更改匯率表後，現有費用資料將刪除，確認執行?");

    if (confirmed) {
      // 用户点击确认，执行更新操作，可以在这里执行更新模态框内表格的操作
      // 更新完成后关闭模态框
      $("#myModal").modal('hide');

      // 弹出确认信息
      alert("更新已确认，模态框已关闭");
    } else {
      // 用户点击取消，还原模态框内表格的数值
      restoreExchangeRate();
    }
  }
});


// 还原更改的汇率数值
function restoreExchangeRate() {
  // 获取模态框内表格的原始汇率数值
  var originalRates = {};
  $("#currtable tbody tr").each(function () {
    var currency = $(this).find("td:eq(0)").text();
    var originalRate = parseFloat($(this).find("td:eq(1) input").data("original-rate"));
    originalRates[currency] = originalRate;
  });

  // 更新模态框内表格的数值
  $("#currtable tbody tr").each(function () {
    var currency = $(this).find("td:eq(0)").text();
    var input = $(this).find("td:eq(1) input");
    input.val(originalRates[currency]);
  });
}






    // 提交按钮点击事件
    $("#submitData").click(function() {
      // 创建一个空的JSON数组来存储表格数据
      var paymentDetailData = tableDataToJson("#paymentdetail tbody tr", ["费用项目", "币别", "金额", "汇率", "付款金额"]);
      var currTableData = tableDataToJson("#currtable tbody tr", ["币别", "汇率"]);
      
      console.log("外层表格数据:");
      console.log(paymentDetailJsonString);
      
      console.log("模态框内表格数据:");
      console.log(currTableJsonString);
    });

 // 计算付款金额并更新表格
 function calculatePaymentAmount(row) {
      var selectedCurrency = row.find(".currency-select").val();
      var exchangeRate = $("#currtable tbody tr:has(td:contains(" + selectedCurrency + ")) input").val();
      var amount = parseFloat(row.find(".amount").val());
      var paymentAmount = amount * exchangeRate;
      row.find(".exchange-rate").val(exchangeRate);
      row.find(".payment-amount").val(paymentAmount.toFixed(2));
    }




 // 将表格数据转换为JSON
 function tableDataToJson(tableSelector, columnNames) {
      var data = [];
      $(tableSelector).each(function() {
        var row = $(this);
        var rowData = {};
        columnNames.forEach(function(columnName, index) {
          rowData[columnName] = index === 1 ? row.find("td:eq(" + index + ") select").val() : parseFloat(row.find("td:eq(" + index + ") input").val());
        });
        data.push(rowData);
      });
      return data;
    }










  </script>
</body>
</html>
